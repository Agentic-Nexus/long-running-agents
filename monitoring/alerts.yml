# Prometheus 告警规则
groups:
  - name: stock_analyzer
    rules:
      # API 错误率告警
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m]))
          /
          sum(rate(http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}"

      # API 延迟告警
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency"
          description: "95th percentile latency is {{ $value }}s"

      # 活跃连接数告警
      - alert: HighActiveConnections
        expr: http_active_connections > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of active connections"
          description: "Active connections: {{ $value }}"

      # LLM 请求失败告警
      - alert: LLMRequestFailed
        expr: |
          sum(rate(llm_requests_total{status="error"}[5m]))
          /
          sum(rate(llm_requests_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "LLM request failure rate is high"
          description: "LLM error rate: {{ $value | humanizePercentage }}"

      # LLM 延迟告警
      - alert: LLMLatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(llm_request_duration_seconds_bucket[5m])) by (le, model)
          ) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "LLM request latency is high"
          description: "95th percentile LLM latency: {{ $value }}s"

      # 缓存命中率低告警
      - alert: LowCacheHitRate
        expr: |
          cache_hits_total / (cache_hits_total + cache_misses_total) < 0.5
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Cache hit rate is low"
          description: "Cache hit rate: {{ $value | humanizePercentage }}"
